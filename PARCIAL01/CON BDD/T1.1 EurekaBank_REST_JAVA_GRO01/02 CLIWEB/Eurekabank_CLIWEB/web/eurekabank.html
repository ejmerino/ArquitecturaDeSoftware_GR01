<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>EurekaBank - Cliente Web</title>
  <link rel="stylesheet" href="resources/estilos.css" />
  <script defer src="js/app.js"></script>
  <style>
    /* Extras ligeros para el saldo actual (puedes moverlos a estilos.css si prefieres) */
    .saldo-banner{
      display:flex; align-items:center; gap:.75rem; margin:.5rem 0 1rem 0;
      padding:.75rem 1rem; border-radius:10px; background:#f2f6ff; border:1px solid #d9e4ff;
    }
    .saldo-valor{ font-weight:700; font-size:1.2rem; }
    .row{ display:flex; gap:.5rem; align-items:center; flex-wrap:wrap; }
  </style>
</head>

<body>
  <h1>EurekaBank Cliente Web</h1>

  <!-- ===============================
       CONSULTAR MOVIMIENTOS
  ================================ -->
  <section class="card">
    <h2>Consultar Movimientos</h2>

    <div class="row">
      <input id="cuentaMov" placeholder="Número de Cuenta" />
      <button id="btnMov">Consultar</button>
    </div>

    <!-- Banner de saldo actual -->
    <div class="saldo-banner" id="saldoBox" style="display:none;">
      <span>Saldo actual:</span>
      <span class="saldo-valor" id="saldoActual">$0.00</span>
    </div>

    <table id="tblMov">
      <thead>
        <tr>
          <th>Fecha</th>
          <th>Tipo</th>
          <th>Importe</th>
          <th>Saldo</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- ===============================
       DEPÓSITO / RETIRO
  ================================ -->
  <section class="card">
    <h2>Depósito / Retiro</h2>
    <div class="row">
      <input id="cuentaDR" placeholder="Cuenta" />
      <input id="importeDR" type="number" step="0.01" placeholder="Importe" />
      <button id="btnDep">Depositar</button>
      <button id="btnRet">Retirar</button>
    </div>
    <p id="msgDR"></p>
  </section>

  <!-- ===============================
       TRANSFERENCIA
  ================================ -->
  <section class="card">
    <h2>Transferencia</h2>
    <div class="row">
      <input id="cuentaOrg" placeholder="Cuenta origen" />
      <input id="cuentaDst" placeholder="Cuenta destino" />
      <input id="importeTr" type="number" step="0.01" placeholder="Importe" />
      <button id="btnTr">Transferir</button>
    </div>
    <p id="msgTr"></p>
  </section>

  <script>
    // ===============================
    // HELPERS
    // ===============================
    const $ = s => document.querySelector(s);

    function fmtMoney(v) {
      const n = parseFloat(v);
      return Number.isFinite(n) ? n.toFixed(2) : "";
    }

    // Prepara movimientos: calcula saldos y ordena por fecha DESC (reciente primero)
    function prepararMovimientos(movs, saldoInicial = 0) {
      // Copias para ordenar sin perder referencias
      const desc = [...movs].sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
      const asc  = [...movs].sort((a, b) => new Date(a.fecha) - new Date(b.fecha));

      // Calculamos el saldo acumulado recorriendo cronológicamente (ascendente)
      let saldo = parseFloat(saldoInicial) || 0;
      for (const m of asc) {
        const tipo = String(m.tipo || "").toLowerCase();
        const imp  = parseFloat(m.importe) || 0;
        if (tipo.includes("apertura") || tipo.includes("deposit")) saldo += imp;
        else if (tipo.includes("retiro") || tipo.includes("cancelar")) saldo -= imp;
        m._saldo = saldo; // se setea en el mismo objeto (afecta desc también)
      }

      const saldoActual = saldo; // último acumulado
      return { movs: desc, saldoActual };
    }

    function mostrarSaldoActual(valor) {
      const box = $("#saldoBox");
      const lbl = $("#saldoActual");
      if (Number.isFinite(valor)) {
        lbl.textContent = `$${fmtMoney(valor)}`;
        box.style.display = "";
      } else {
        lbl.textContent = "$0.00";
        box.style.display = "none";
      }
    }

    // ===============================
    // CONSULTAR MOVIMIENTOS
    // ===============================
    $("#btnMov").addEventListener("click", async () => {
      const cuenta = $("#cuentaMov").value.trim();
      const tbody  = $("#tblMov tbody");
      tbody.innerHTML = "";
      mostrarSaldoActual(NaN);
      if (!cuenta) return alert("Ingresa un número de cuenta.");

      try {
        let data = await apiGetMovimientos(cuenta);
        if (!Array.isArray(data) || data.length === 0) {
          tbody.innerHTML = `<tr><td colspan="4">Sin movimientos</td></tr>`;
          return;
        }

        // Calcular saldos y ordenar (más reciente primero)
        const { movs, saldoActual } = prepararMovimientos(data, /* saldoInicial */ 0);
        mostrarSaldoActual(saldoActual);

        const rows = movs.map(m => `
          <tr>
            <td>${m.fecha ?? ""}</td>
            <td>${m.tipo ?? ""}</td>
            <td>${fmtMoney(m.importe)}</td>
            <td>${fmtMoney(m.saldo ?? m._saldo)}</td>
          </tr>
        `).join("");

        tbody.innerHTML = rows;

      } catch (err) {
        console.error(err);
        tbody.innerHTML = `<tr><td colspan="4">Error cargando movimientos</td></tr>`;
      }
    });

    // ===============================
    // DEPÓSITO
    // ===============================
    $("#btnDep").addEventListener("click", async () => {
      const cuenta = $("#cuentaDR").value.trim();
      const importe = $("#importeDR").value;
      const msg = $("#msgDR");
      if (!cuenta || !importe) return alert("Completa cuenta e importe.");
      try {
        const r = await apiDeposito(cuenta, importe);
        msg.textContent = r?.estado === 1 ? "✅ Depósito realizado correctamente." : JSON.stringify(r);
      } catch (err) {
        console.error(err);
        msg.textContent = "❌ Error al realizar depósito.";
      }
    });

    // ===============================
    // RETIRO
    // ===============================
    $("#btnRet").addEventListener("click", async () => {
      const cuenta = $("#cuentaDR").value.trim();
      const importe = $("#importeDR").value;
      const msg = $("#msgDR");
      if (!cuenta || !importe) return alert("Completa cuenta e importe.");
      try {
        const r = await apiRetiro(cuenta, importe);
        msg.textContent = r?.estado === 1 ? "✅ Retiro realizado correctamente." : JSON.stringify(r);
      } catch (err) {
        console.error(err);
        msg.textContent = "❌ Error al realizar retiro.";
      }
    });

    // ===============================
    // TRANSFERENCIA
    // ===============================
    $("#btnTr").addEventListener("click", async () => {
      const origen = $("#cuentaOrg").value.trim();
      const destino = $("#cuentaDst").value.trim();
      const importe = $("#importeTr").value;
      const msg = $("#msgTr");
      if (!origen || !destino || !importe) return alert("Completa todos los campos.");
      try {
        const r = await apiTransferencia(origen, destino, importe);
        msg.textContent = r?.estado === 1 ? "✅ Transferencia realizada correctamente." : JSON.stringify(r);
      } catch (err) {
        console.error(err);
        msg.textContent = "❌ Error en transferencia.";
      }
    });
  </script>
</body>
</html>

